# Изображения и конвертация в AVIF

[← Назад к README](../README.md)

## Форматы

- Исходные: `.2x.png`, `.2x.jpg`, `.2x.jpeg`
- Целевые: `.2x.avif`, `.1x.avif`, `.mobile.2x.avif`, `.mobile.1x.avif`
- Хранить в `images/` внутри папки статьи.

## Конвертация (Node.js — рекомендуется)

```bash
cd src/game-lore-library
npm ci

# Оба окружения
npm run images:avif

# Только stage
npm run images:avif:stage

# Только production
npm run images:avif:production

# Тонкая настройка качества/усилий
node tools/images-avif.mjs -e stage -q 60 -E 6

# Принудительная перегенерация и подробные логи
node tools/images-avif.mjs -e both -f -v
```

Скрипт создаёт/обновляет `.avif` рядом с исходниками и по умолчанию пропускает уже существующие целевые файлы (инкрементально). Для пересоздания используйте флаг `--force`.
По умолчанию работает для окружения `stage`. Опция `-e both` обрабатывает оба окружения; если одно из окружений отсутствует (например, `production/`), оно будет пропущено без ошибки.

## Что делает конвертер

Конвертер автоматически:

- Ищет исходники только по пути `src/game-lore-library/<env>/articles/*/images/`
- Обрабатывает файлы формата `*.2x.(png|jpg|jpeg)`
- Генерирует для каждого исходника 4 файла:
  - Десктоп: `<name>.2x.avif` и `<name>.1x.avif`
  - Мобильные: `<name>.mobile.2x.avif` и `<name>.mobile.1x.avif`
- Масштабы:
  - desktop: коэффициент 1.0 для `.2x`, а `.1x` — это 50% от `.2x`
  - mobile: коэффициент 0.55 для `.mobile.2x`, а `.mobile.1x` — это 50% от `.mobile.2x`
- Сохраняет новые файлы рядом с оригиналами, исходники не удаляются
- Пропускает уже существующие целевые файлы (для пересоздания используйте `--force`)

### Параметры CLI

Скрипт `tools/images-avif.mjs` принимает флаги:

- `-e, --env <stage|production|both>` — окружение (по умолчанию `stage`)
- `-q, --quality <int>` — качество AVIF (по умолчанию 55)
- `-E, --effort <int>` — усилие кодирования (по умолчанию 4)
- `-f, --force` — перезаписывать существующие целевые файлы
- `-v, --verbose` — подробные логи по каждому файлу (SKIP/CREATE/FORCE)

На выход печатает краткую статистику по окружению: количество целей, созданных и пропущенных файлов. При `--verbose` дополнительно выводит ход обработки по каждой статье и каждому файлу.
